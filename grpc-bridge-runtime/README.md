# RESTEasy Protobuf Provider

The RESTEasy protobuf provider supports exposing JAX-RS services to gRPC clients.

It supports the following features:

* translation of resource classes to .proto descriptor files
* generation of gRPC service implementation classes that dispatch gRPC invocations to the appropriate JAX-RS resources
* generation of MessageBodyReader and MessageBodyWriter classes that convert requests 
  and responses between gRPC and JAX-RS formats

There are a lot of moving pieces in this provider, but its usage is captured in the [gRPCtoJAXRS_archetype 
project](https://github.com/ronsigal/gRPCtoJAXRS_archetype).

## Infrastructure

1. `org.jboss.resteasy.plugins.protobuf.JavaToProtobufGenerator` translates a JAX-RS 
   resource into a protobuf descriptor file. Using the [JavaParser](https://github.com/javaparser/javaparser) project,
   it gathers information to create a .proto file.
   
   A. For each JAX-RS resource method, it creates an *rpc* entry.
   
   B. It finds the transitive closure of the classes referred to in the resource methods, and, for each, creates a *message* entry.

   **Note.** The protobuf syntax doesn't support inheritence, so `JavaToProtobufGenerator` uses a designated field to represent
   a parent object.
   
   **Note**. `JavaToProtobufGenerator` embodies a heuristic method that is not guaranteed to find all classes sent back and forth.
   The set of classes may need to be manually augmented with a list of additional classes. [To be implemented.]

2. When the .proto file is compiled, a `ServiceGrpc` class is generated which has a stub method for each rpc entry in the .proto file.
   `org.jboss.resteasy.grpc.JaxrsImplBaseExtender` uses a `java.util.Scanner` to parse the compiled output of the .proto file, and it 
   generates a `ServiceGrpcImpl` class which overrides each stub method with a method that passes the request into the appropriate
   JAX-RS service.
   
3. For each class discovered by `JavaToProtobufGenerator,` there are two versions:

   A. the original class, and
   
   B. the corresponding Java class generated from the .proto file by the protobuf compiler. This latter class we refer to as the **javabuf** version.

   The javabuf classes are contained in a wrapper class generated by the protobuf compiler.
   `org.jboss.resteasy.plugins.protobuf.JavabufTranslatorGenerator` examines the wrapper class and generates a class with static methods 
   that can translate back and before between the original classes and their javabuf counterparts.
   
 4. `org.jboss.resteasy.plugins.protobuf.ReaderWriterGenerator` examines the wrapper class and generates a class that implements
    `javax.ws.rs.ext.MessageBodyReader` and `javax.ws.rs.ext.MessageBodyWriter`. This class is intended to be registered with the
    RESTEasy runtime so that it is available, with a suitably high priority, to 
    
    A. translate javabuf objects in the request to their original Java counterparts, and
    
    B. translate the response object to its javabuf counterpart.
    
    The class generated by `JavabufTranslatorGenerator` takes care of the details.

## To Do

The protobuf provider is a work in progress. A great deal needs to be done, including:

 1. Figure out what to do about non entity resource method parameters.
 
 2. Special treatment for resource methods that return `javax.ws.rs.core.Response`s.
 
 3. Handle multiple JAX-RS resource classes
 
 4. Lots of testing.
 
 5. Probably lots of other stuff.
